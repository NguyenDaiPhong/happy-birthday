<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Happy Birthday</title>
  <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet">
  <style>
    html, body {
      margin: 0;
      overflow: hidden;
      background: rgb(242, 158, 172); 
      font-family: 'Patrick Hand', 'Comic Sans MS', cursive;
    }
    canvas {
      display: block;
    }
    
    .header-message {
      position: absolute;
      top: 60px;
      width: 100%;
      text-align: center;
      font-size: 42px;
      color: #c9003b; 
      text-shadow: 1px 1px 3px rgba(255, 255, 255, 0.7);
      z-index: 5;
      display: none;
    }

    .message {
      position: absolute;
      bottom: 60px;
      width: 100%;
      text-align: center;
      font-size: 42px;
      color: gold;
      text-shadow: 2px 2px 5px #000;
      z-index: 5;
      display: none; 
    }

    /* === CSS POPUP V·ªöI VI·ªÄN ANIMATION === */
    .popup {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      
      border-radius: 18px; 
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      display: none;
      z-index: 10;
      width: 600px; 
      max-width: 80%; 
      min-height: 250px; 
      overflow: hidden;
      
      background: transparent; 
    }
    .popup::before {
      content: '';
      position: absolute;
      inset: 0;
      z-index: 1;
      background: conic-gradient(
        from 180deg at 50% 50%, 
        #FF69B4, #9370DB, #00BFFF, #32CD32, #FFD700, #FF6347, #FF69B4
      );
      animation: rotateBorder 4s linear infinite;
      border-radius: 18px; 
    }
    .popup-inner-bg {
      position: relative;
      z-index: 2;
      background: #ffffff;
      border-radius: 16px; 
      overflow: hidden; 
      padding: 20px; 
      display: flex; 
      flex-direction: column; 
      justify-content: center; 
      align-items: center; 
      height: 100%; 
    }
    .popup-content {
        padding: 40px; 
        text-align: center;
        font-family: 'Patrick Hand', cursive;
        color: #c9003b;
        font-size: 28px; 
        font-weight: bold;
        line-height: 1.8; 
    }
    .popup .waves {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 60px; 
      overflow: hidden; 
    }
    .popup .wave {
      position: absolute;
      bottom: -30px; 
      width: 150%; 
      height: 100px;
      border-radius: 50%;
      opacity: 0.7;
      animation: waveMovement 10s linear infinite; 
    }
    .popup .wave1 { background-color: #ffe0e6; left: -20%; animation-delay: 0s; }
    .popup .wave2 { background-color: #d1efff; left: 10%; animation-delay: 3s; }
    .popup .wave3 { background-color: #fff6e0; left: 40%; animation-delay: 6s; }
    @keyframes rotateBorder {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    @keyframes waveMovement {
      0% { transform: translateX(0); }
      100% { transform: translateX(-50%); } 
    }
    /* === K·∫æT TH√öC CSS POPUP === */

    .gift-box {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      cursor: pointer;
      display: none;
      z-index: 3;
      animation: bounce 1.2s infinite;
    }
    .gift-box img {
      width: 160px;
      height: auto;
      user-select: none;
    }
    @keyframes bounce {
      0%, 100% { transform: translate(-50%, -50%) scale(1); }
      50% { transform: translate(-50%, -55%) scale(1.05); }
    }
    .gift-message {
      position: absolute;
      top: 65%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 28px;
      color: #c9003b; 
      font-weight: bold;
      text-shadow: 1px 1px 3px rgba(255, 255, 255, 0.7);
      display: none; 
      z-index: 3;
      animation: bounce 1.2s infinite; 
      font-family: 'Patrick Hand', cursive;
    }
    .initial-message {
      position: absolute;
      top: 45%; 
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 32px; 
      color: #c9003b; 
      font-weight: bold;
      text-shadow: 1px 1px 3px rgba(255, 255, 255, 0.7);
      display: block; 
      z-index: 3;
      animation: bounce 1.2s infinite; 
      font-family: 'Patrick Hand', cursive;
      line-height: 1.5; 
    }
    .moment-container {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      display: none;
      z-index: 3;
      animation: fadeIn 1.5s ease forwards;
      width: 80vw;
      height: 70vh;
      display: none;
    }
    .moment-slide {
      max-width: 100%;
      max-height: 100%;
      border-radius: 12px;
      box-shadow: 0 0 25px rgba(255,255,255,0.4);
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      opacity: 0;
      transition: opacity 1.0s ease-in-out;
    }
    .moment-slide.active { opacity: 1; }
    .caption { display: none; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translate(-50%, -55%); }
      to { opacity: 1; transform: translate(-50%, -50%); }
    }
    .fade-out { animation: fadeOutCake 3s forwards; }
    @keyframes fadeOutCake {
      from { opacity: 1; }
      to { opacity: 0; }
    }
  </style>
</head>
<body>

<audio id="birthdayMusic" src="img/hpbd.mp3" loop></audio>
<canvas id="canvas"></canvas>

<div class="header-message">H√£y lu√¥n vui v·∫ª v√† c∆∞·ªùi th·∫≠t t∆∞∆°i nh∆∞ n√†y nh√©!!!</div>
<div class="message">üéÇ Happy Birthday Tiu Tiu üéâ</div>

<div class="popup" id="popup">
  <div class="popup-inner-bg">
    <div class="popup-content">
      üíñ Ch√∫c Tiu Tiu sinh nh·∫≠t vui v·∫ª, tu·ªïi m·ªõi th√™m nhi·ªÅu ni·ªÅm vui m·ªõi, <br>
      c·∫ßu g√¨ ƒë∆∞·ª£c n·∫•y, c·∫ßu ti·ªÅn ƒë∆∞·ª£c ti·ªÅn, c·∫ßu t√¨nh ƒë∆∞·ª£c t√¨nh, c·∫ßu t√†i ƒë∆∞·ª£c t√†i nhoazzz! üíñ
    </div>
    <div class="waves">
      <div class="wave wave1"></div>
      <div class="wave wave2"></div>
      <div class="wave wave3"></div>
    </div>
  </div>
</div>

<div class="gift-box" id="giftBox">
  <img src="https://png.pngtree.com/png-clipart/20220125/original/pngtree-gift-box-gift-box-png-image_7213113.png" alt="Gift box">
</div>

<div class="gift-message" id="giftMessage">
  Tiu Tiu nh·∫•n v√†o h·ªôp qu√† ƒëii
</div>

<div class="initial-message" id="initialMessage">
  Tiu Tiu nh·∫•n v√†o m√†n h√¨nh ƒëii
</div>

<div class="moment-container" id="momentContainer">
  <img src="img/1.jpeg" alt="K·ª∑ ni·ªám 1" class="moment-slide">
  <img src="img/2.jpeg" alt="K·ª∑ ni·ªám 2" class="moment-slide">
  <img src="img/3.jpeg" alt="K·ª∑ ni·ªám 3" class="moment-slide">
  <img src="img/4.jpeg" alt="K·ª∑ ni·ªám 4" class="moment-slide">
  <img src="img/5.jpeg" alt="K·ª∑ ni·ªám 5" class="moment-slide">
  <img src="img/6.jpeg" alt="K·ª∑ ni·ªám 6" class="moment-slide">
  <img src="img/7.jpeg" alt="K·ª∑ ni·ªám 6" class="moment-slide"> ¬†
  <img src="img/9.jpeg" alt="K·ª∑ ni·ªám 6" class="moment-slide">
  <img src="img/8.jpeg" alt="K·ª∑ ni·ªám 6" class="moment-slide">
</div>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
let W = canvas.width = window.innerWidth;
let H = canvas.height = window.innerHeight;
let time = 0;

let clickState = 0;
let cakeOpacity = 0; 
let animationStarted = false;

const cake = { x: W / 2, y: H / 2 + 30, width: 340, height: 60, tiers: 3 };

const candles = [
  { offset: -80, flame: true, color: "#FFD700" },
  { offset: -40, flame: true, color: "#00BFFF" },
  { offset: 0, flame: true, color: "#FF69B4" },
  { offset: 40, flame: true, color: "#32CD32" },
  { offset: 80, flame: true, color: "#9370DB" }
];

const confetti = [];
const balloons = [];

const popup = document.getElementById("popup");
const giftBox = document.getElementById("giftBox");
const giftMessage = document.getElementById("giftMessage");
const initialMessage = document.getElementById("initialMessage");
const momentContainer = document.getElementById("momentContainer");
const headerMessage = document.querySelector(".header-message");
const footerMessage = document.querySelector(".message"); 
const birthdayMusic = document.getElementById("birthdayMusic");

const slides = momentContainer.getElementsByClassName("moment-slide");
const SLIDE_DURATION = 3000;
let slideIndex = 0;
let slideInterval;

function drawCake() {
  ctx.globalAlpha = cakeOpacity;
  const tierHeight = cake.height, tierGap = 15;
  for (let i = 0; i < cake.tiers; i++) {
    const tierWidth = cake.width - i * 60;
    const x = cake.x - tierWidth / 2;
    const y = cake.y - i * (tierHeight + tierGap);
    ctx.beginPath();
    ctx.fillStyle = "#87CEFA";
    ctx.fillRect(x, y, tierWidth, tierHeight);
    ctx.strokeStyle = "white";
    ctx.lineWidth = 3;
    ctx.strokeRect(x, y, tierWidth, tierHeight);
    for (let j = 10; j < tierWidth - 10; j += 20) {
      ctx.beginPath();
      ctx.fillStyle = "white";
      ctx.arc(x + j, y + 10, 4, 0, Math.PI * 2);
      ctx.fill();
    }
  }
  ctx.globalAlpha = 1;
}
function drawCandles() {
  if (cakeOpacity <= 0) return;
  const topY = cake.y - cake.tiers * (cake.height + 15) + 10;
  candles.forEach(c => {
    const cx = cake.x + c.offset;
    const cy = topY - 20;
    ctx.fillStyle = c.color;
    ctx.fillRect(cx - 6, cy + 20, 12, 50);
    if (c.flame) {
      const flameHeight = 20, flameWidth = 12;
      const offset = Math.sin(time / 20 + c.offset) * 2;
      ctx.beginPath();
      ctx.moveTo(cx, cy - flameHeight + offset); 
      ctx.bezierCurveTo(
        cx + flameWidth, cy - flameHeight / 2 + offset,
        cx + flameWidth / 2, cy + 10 + offset,
        cx, cy + 10 + offset
      );
      ctx.bezierCurveTo(
        cx - flameWidth / 2, cy + 10 + offset,
        cx - flameWidth, cy - flameHeight / 2 + offset,
        cx, cy - flameHeight + offset
      );
      ctx.fillStyle = "gold";
      ctx.fill();
    }
  });
}
function drawConfetti() {
  if (confetti.length < 60) {
    confetti.push({
      x: Math.random() * W,
      y: Math.random() * H,
      color: `hsl(${Math.random() * 360}, 100%, 50%)`,
      size: 5 + Math.random() * 3,
      speed: 1 + Math.random() * 2
    });
  }
  confetti.forEach(c => {
    ctx.fillStyle = c.color;
    ctx.fillRect(c.x, c.y, c.size, c.size);
    c.y += c.speed;
    if (c.y > H) { c.y = -10; c.x = Math.random() * W; }
  });
}
function drawBalloons() {
  if (balloons.length < 6) {
    balloons.push({
      x: Math.random() * W,
      y: H + Math.random() * 100,
      color: `hsl(${Math.random() * 360}, 70%, 60%)`,
      radius: 25 + Math.random() * 10,
      speed: 1 + Math.random()
    });
  }
  balloons.forEach(b => {
    ctx.beginPath();
    ctx.fillStyle = b.color;
    ctx.ellipse(b.x, b.y, b.radius, b.radius * 1.3, 0, 0, Math.PI * 2);
    ctx.fill();
    ctx.beginPath();
    ctx.moveTo(b.x, b.y + b.radius * 1.3);
    ctx.lineTo(b.x, b.y + b.radius * 1.3 + 20);
    ctx.strokeStyle = "white";
    ctx.stroke();
    b.y -= b.speed;
    if (b.y < -50) { b.y = H + Math.random() * 100; b.x = Math.random() * W; }
  });
}

function showPopup() {
    momentContainer.style.display = "none";
    headerMessage.style.display = "none"; 
    
    setTimeout(() => {
        birthdayMusic.pause();
    }, 20000); // <-- Gi·ªØ nguy√™n 20s

    if (slides.length > 0) {
      slides[slides.length - 1].classList.remove("active");
    }
    popup.style.display = "block";
    clickState = 3; 
}

// T√°ch logic ra h√†m ri√™ng
function runBirthdayLogic() {
  if (clickState !== 0.5) return; 

  animationStarted = true;
  footerMessage.style.display = "block";
  
  cakeOpacity = 1;
  candles.forEach(c => c.flame = true); 

  setTimeout(() => {
    candles.forEach(c => c.flame = false);
    let fadeInterval = setInterval(() => {
      cakeOpacity -= 0.02;
      if (cakeOpacity <= 0) {
        cakeOpacity = 0;
        clearInterval(fadeInterval);
        giftBox.style.display = "block";
        giftMessage.style.display = "block";
        clickState = 1; 
      }
    }, 80);
  }, 3000);
}


function handleInteraction(e) {
  e.preventDefault();

  // Click 1
  if (clickState === 0) {
    initialMessage.style.display = "none";
    clickState = 0.5; 

    // === S·ª¨A L·ªñI √ÇM THANH IOS/ANDROID ===
    // T·∫£i (load) v√† Ph√°t (play) ngay l·∫≠p t·ª©c
    birthdayMusic.load();
    var playPromise = birthdayMusic.play();

    // X·ª≠ l√Ω l·ªói (n·∫øu c√≥) m√† KH√îNG CH·∫∂N lu·ªìng ch√≠nh
    if (playPromise !== undefined) {
      playPromise.catch(error => {
        console.log("L·ªói t·ª± ƒë·ªông ph√°t nh·∫°c:", error);
        // Th·ª≠ ph√°t l·∫°i m·ªôt c√°ch "im l·∫∑ng"
        birthdayMusic.load();
        birthdayMusic.play();
      });
    }
    
    // CH·∫†Y LOGIC SINH NH·∫¨T NGAY L·∫¨P T·ª®C
    runBirthdayLogic();
    // === K·∫æT TH√öC S·ª¨A L·ªñI ===
  } 
  // Click 3: B·ªè qua
  else if (clickState === 2) {
    // Kh√¥ng l√†m g√¨ c·∫£
  }
}

// Gi·ªØ nguy√™n h√†m runSlideshow c·ªßa B·∫†N (cross-fade m∆∞·ª£t)
function runSlideshow() {
    if (slides.length === 0) return;
    
    for (let i = 0; i < slides.length; i++) {
        slides[i].classList.remove("active");
    }
    
    slideIndex = 0;
    slides[slideIndex].classList.add("active");
    
    slideInterval = setInterval(() => {
        let oldIndex = slideIndex;
        slideIndex++;
        
        if (slideIndex >= slides.length) {
            clearInterval(slideInterval);
            slides[oldIndex].classList.remove("active");
            setTimeout(showPopup, 1000); 
        } else {
            slides[oldIndex].classList.remove("active");
            slides[slideIndex].classList.add("active");
        }
    }, SLIDE_DURATION);
}

// Click 2
giftBox.addEventListener("click", (e) => {
  e.stopPropagation(); 
  giftBox.style.display = "none";
  giftMessage.style.display = "none"; 
  momentContainer.style.display = "block";
  
  headerMessage.style.display = "block"; 

  runSlideshow();
});

window.addEventListener("click", handleInteraction);
window.addEventListener("touchstart", handleInteraction);

function loop() {
  time++;
  ctx.clearRect(0, 0, W, H);
  
  if (animationStarted) {
    drawConfetti();
    drawBalloons();
  }
  
  drawCake(); 
  drawCandles(); 
  requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
